#!/bin/sh

# Environment variables
XDG_DATA_HOME=${XDG_DATA_HOME:-~/.local/share}

if test -n "$KAKOUNE_SESSION" -o -n "$KAKOUNE_CLIENT"; then
  edit "$@"
elif test -t 1; then
  kak_session=$$
  # Start a connected shell or edit files.
  if test $# -eq 0; then
    cat <<EOF
Starting a shell connected to the '$kak_session' Kakoune session.

• [e]dit to attach
• CTRL-D to quit

❯ (connect-shell) █
EOF
    set -- "$SHELL"
  else
    set -- 'edit' "$@"
  fi
  kak -s "$kak_session" -d
  kak -c "$kak_session" -e "
    alias global terminal connect-detach
    set-option global connect_environment %{
      KAKOUNE_CLIENT=''
    }
    connect-terminal $@
  "
  # Attach the connect terminal command
  script_path=$XDG_DATA_HOME/kak/connect/$kak_session/script.sh
  if test -e "$script_path"; then
    mv "$script_path" "$script_path~"
    sh "$script_path~"
    rm -f "$script_path~"
  fi
else
  file=$1 line=$2 column=$3
  kak -ui dummy -e "
    new %{
      hook -always -once global ClientClose %val{client} kill!
      edit %{$file} $line $column
    }
  "
fi
